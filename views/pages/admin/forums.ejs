<%- include('../../layouts/main', {
    title: title,
    body: `
        <main class="container">
            <header>
                <nav aria-label="breadcrumb">
                    <ol>
                        <li><a href="/admin">ê´€ë¦¬ì</a></li>
                        <li>ì„œë¸Œí¬ëŸ¼ ê´€ë¦¬</li>
                    </ol>
                </nav>

                <div class="page-header">
                    <h1>ì„œë¸Œí¬ëŸ¼ ê´€ë¦¬</h1>
                    <a href="/admin/forums/new" role="button">ìƒˆ ì„œë¸Œí¬ëŸ¼ ìƒì„±</a>
                </div>
            </header>

            <!-- ì„±ê³µ ë©”ì‹œì§€ -->
            ${typeof success !== 'undefined' && success ?
                '<div class="alert success">' + success + '</div>' : ''
            }

            <!-- ì„œë¸Œí¬ëŸ¼ ëª©ë¡ -->
            <section class="categories-management">
                ${subforums.length > 0 ? `
                    <div class="categories-table">
                        <div class="table-header">
                            <div class="col-order">ìˆœì„œ</div>
                            <div class="col-name">ì´ë¦„</div>
                            <div class="col-description">ì„¤ëª…</div>
                            <div class="col-stats">í†µê³„</div>
                            <div class="col-status">ìƒíƒœ</div>
                            <div class="col-actions">ì‘ì—…</div>
                        </div>

                        <div id="categories-list" class="sortable-list">
                            ${subforums.map((subforum, index) => `
                                <div class="category-row" data-id="${subforum.id}">
                                    <div class="col-order">
                                        <span class="drag-handle">â‹®â‹®</span>
                                        <span class="order-number">${subforum.display_order}</span>
                                    </div>

                                    <div class="col-name">
                                        <strong>${subforum.name}</strong>
                                        <br>
                                        <small>ID: ${subforum.id}</small>
                                    </div>

                                    <div class="col-description">
                                        ${subforum.description || '<em>ì„¤ëª… ì—†ìŒ</em>'}
                                    </div>

                                    <div class="col-stats">
                                        <div>ê²Œì‹œê¸€: ${subforum.post_count || 0}</div>
                                        <div>ëŒ“ê¸€: ${subforum.comment_count || 0}</div>
                                    </div>

                                    <div class="col-status">
                                        <span class="status-badge ${subforum.is_active ? 'active' : 'inactive'}">
                                            ${subforum.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                                        </span>
                                    </div>

                                    <div class="col-actions">
                                        <a href="/forum/subforum/${subforum.id}"
                                           class="btn-small secondary"
                                           target="_blank"
                                           title="í¬ëŸ¼ ë³´ê¸°">
                                            ğŸ‘ï¸
                                        </a>
                                        <a href="/admin/forums/${subforum.id}/edit"
                                           class="btn-small"
                                           title="ìˆ˜ì •">
                                            âœï¸
                                        </a>
                                        <button onclick="deleteSubforum(${subforum.id}, '${subforum.name}')"
                                                class="btn-small danger"
                                                title="ì‚­ì œ"
                                                ${subforum.post_count > 0 ? 'disabled' : ''}>
                                            ğŸ—‘ï¸
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="empty-state">
                        <p>ì•„ì§ ìƒì„±ëœ ì„œë¸Œí¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <a href="/admin/forums/new" role="button">ì²« ë²ˆì§¸ ì„œë¸Œí¬ëŸ¼ì„ ìƒì„±í•´ë³´ì„¸ìš”!</a>
                    </div>
                `}
            </section>
        </main>

        <style>
            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--pico-muted-border-color);
            }

            .alert {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: var(--pico-border-radius);
                border: 1px solid;
            }

            .alert.success {
                background: var(--pico-ins-background-color);
                border-color: var(--pico-ins-color);
                color: var(--pico-ins-color);
            }

            .categories-table {
                background: var(--pico-card-background-color);
                border-radius: var(--pico-border-radius);
                overflow: hidden;
                box-shadow: var(--pico-card-box-shadow);
            }

            .table-header {
                display: grid;
                grid-template-columns: 80px 1fr 1fr 120px 80px 120px;
                gap: 1rem;
                padding: 1rem;
                background: var(--pico-primary-background);
                color: var(--pico-primary-inverse);
                font-weight: bold;
            }

            .category-row {
                display: grid;
                grid-template-columns: 80px 1fr 1fr 120px 80px 120px;
                gap: 1rem;
                padding: 1rem;
                border-bottom: 1px solid var(--pico-muted-border-color);
                transition: background-color 0.2s;
                cursor: move;
            }

            .category-row:hover {
                background: var(--pico-secondary-background);
            }

            .category-row:last-child {
                border-bottom: none;
            }

            .col-order {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .drag-handle {
                cursor: grab;
                color: var(--pico-muted-color);
                font-size: 1.2rem;
            }

            .drag-handle:active {
                cursor: grabbing;
            }

            .order-number {
                font-weight: bold;
                color: var(--pico-primary);
            }

            .col-name strong {
                color: var(--pico-color);
            }

            .col-name small {
                color: var(--pico-muted-color);
            }

            .col-description {
                color: var(--pico-muted-color);
                font-size: 0.9rem;
                line-height: 1.3;
            }

            .col-stats {
                font-size: 0.85rem;
                color: var(--pico-muted-color);
            }

            .col-stats div {
                margin-bottom: 0.25rem;
            }

            .status-badge {
                display: inline-block;
                padding: 0.2rem 0.5rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: bold;
                text-transform: uppercase;
            }

            .status-badge.active {
                background: var(--pico-ins-background-color);
                color: var(--pico-ins-color);
            }

            .status-badge.inactive {
                background: var(--pico-del-background-color);
                color: var(--pico-del-color);
            }

            .col-actions {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .btn-small {
                display: inline-block;
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
                text-decoration: none;
                border-radius: var(--pico-border-radius);
                border: none;
                cursor: pointer;
                background: var(--pico-primary);
                color: var(--pico-primary-inverse);
            }

            .btn-small.secondary {
                background: var(--pico-secondary);
                color: var(--pico-secondary-inverse);
            }

            .btn-small.danger {
                background: var(--pico-del-color);
                color: white;
            }

            .btn-small:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-small:hover:not(:disabled) {
                opacity: 0.8;
            }

            .empty-state {
                text-align: center;
                padding: 3rem 1rem;
                color: var(--pico-muted-color);
            }

            .sortable-ghost {
                opacity: 0.5;
            }

            .sortable-chosen {
                background: var(--pico-primary-background);
            }

            /* ë°˜ì‘í˜• ë””ìì¸ */
            @media (max-width: 768px) {
                .page-header {
                    flex-direction: column;
                    gap: 1rem;
                    align-items: stretch;
                }

                .table-header, .category-row {
                    grid-template-columns: 1fr;
                    gap: 0.5rem;
                }

                .col-order, .col-stats, .col-status, .col-actions {
                    font-size: 0.8rem;
                }

                .col-actions {
                    justify-content: center;
                }
            }
        </style>

        <script>
            // ì„œë¸Œí¬ëŸ¼ ì‚­ì œ í•¨ìˆ˜
            async function deleteSubforum(subforumId, subforumName) {
                if (!confirm('ì •ë§ë¡œ "' + subforumName + '" ì„œë¸Œí¬ëŸ¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    return;
                }

                try {
                    const response = await fetch('/admin/forums/' + subforumId + '/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        location.reload();
                    } else {
                        alert('ì˜¤ë¥˜: ' + result.error);
                    }
                } catch (error) {
                    console.error('ì„œë¸Œí¬ëŸ¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ì„œë¸Œí¬ëŸ¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½ (ê°„ë‹¨í•œ êµ¬í˜„)
            document.addEventListener('DOMContentLoaded', function() {
                const categoriesList = document.getElementById('categories-list');
                if (!categoriesList) return;

                let draggedElement = null;

                // ë“œë˜ê·¸ ì‹œì‘
                categoriesList.addEventListener('dragstart', function(e) {
                    if (e.target.classList.contains('category-row')) {
                        draggedElement = e.target;
                        e.target.style.opacity = '0.5';
                    }
                });

                // ë“œë˜ê·¸ ì¢…ë£Œ
                categoriesList.addEventListener('dragend', function(e) {
                    if (e.target.classList.contains('category-row')) {
                        e.target.style.opacity = '';
                        draggedElement = null;
                    }
                });

                // ë“œë¡­ í—ˆìš©
                categoriesList.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });

                // ë“œë¡­ ì²˜ë¦¬
                categoriesList.addEventListener('drop', function(e) {
                    e.preventDefault();

                    if (draggedElement && e.target.classList.contains('category-row')) {
                        const allRows = Array.from(categoriesList.children);
                        const draggedIndex = allRows.indexOf(draggedElement);
                        const targetIndex = allRows.indexOf(e.target);

                        if (draggedIndex !== targetIndex) {
                            if (draggedIndex < targetIndex) {
                                categoriesList.insertBefore(draggedElement, e.target.nextSibling);
                            } else {
                                categoriesList.insertBefore(draggedElement, e.target);
                            }

                            updateCategoryOrder();
                        }
                    }
                });

                // ì¹´í…Œê³ ë¦¬ í–‰ì„ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
                const categoryRows = categoriesList.querySelectorAll('.category-row');
                categoryRows.forEach(row => {
                    row.draggable = true;
                });
            });

            // ì„œë¸Œí¬ëŸ¼ ìˆœì„œ ì—…ë°ì´íŠ¸
            async function updateCategoryOrder() {
                const rows = document.querySelectorAll('.category-row');
                const subforums = Array.from(rows).map((row, index) => ({
                    id: parseInt(row.dataset.id),
                    displayOrder: index
                }));

                try {
                    const response = await fetch('/admin/forums/reorder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ subforums: subforums })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // ìˆœì„œ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                        rows.forEach((row, index) => {
                            const orderNumber = row.querySelector('.order-number');
                            if (orderNumber) {
                                orderNumber.textContent = index;
                            }
                        });
                    } else {
                        alert('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨: ' + result.error);
                        location.reload();
                    }
                } catch (error) {
                    console.error('ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:', error);
                    alert('ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                }
            }

            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const urlParams = new URLSearchParams(window.location.search);
            const successMessage = urlParams.get('success');
            if (successMessage) {
                // URLì—ì„œ success íŒŒë¼ë¯¸í„° ì œê±°
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        </script>
    `
}) %>