<%- include('../../layouts/main', { body: `
<div class="container">
    <nav aria-label="breadcrumb">
        <ul>
            <li><a href="/">홈</a></li>
            <li><a href="/admin">관리자</a></li>
            <li>사용자 관리</li>
        </ul>
    </nav>

    <hgroup>
        <h1>사용자 관리</h1>
        <p>포럼 사용자 목록 및 권한 관리</p>
    </hgroup>

    <!-- 검색 및 필터 -->
    <article>
        <form method="GET" action="/admin/users">
            <div class="grid">
                <div>
                    <label for="search">
                        검색
                        <input
                            type="text"
                            id="search"
                            name="search"
                            placeholder="사용자명 또는 이메일 검색"
                            value="${filters.search || ''}">
                    </label>
                </div>
                <div>
                    <label for="role">
                        역할 필터
                        <select id="role" name="role">
                            <option value="">전체</option>
                            <option value="user" ${filters.role === 'user' ? 'selected' : ''}>일반 사용자</option>
                            <option value="moderator" ${filters.role === 'moderator' ? 'selected' : ''}>모더레이터</option>
                            <option value="super_admin" ${filters.role === 'super_admin' ? 'selected' : ''}>슈퍼 관리자</option>
                        </select>
                    </label>
                </div>
            </div>
            <button type="submit">검색</button>
        </form>
    </article>

    <!-- 사용자 목록 -->
    <article>
        ${users.length === 0 ? `
            <p style="text-align: center; color: var(--muted-color);">
                검색 결과가 없습니다.
            </p>
        ` : `
            <table role="grid">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>사용자명</th>
                        <th>이메일</th>
                        <th>역할</th>
                        <th>가입일</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>
                                ${user.role === 'super_admin' ? '<span style="color: var(--primary);">슈퍼 관리자</span>' :
                                  user.role === 'moderator' ? '<span style="color: var(--secondary);">모더레이터</span>' :
                                  '일반 사용자'}
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                            <td>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <a
                                        href="/admin/moderators?userId=${user.id}"
                                        class="secondary outline"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.875rem; text-decoration: none; display: inline-block;">
                                        권한 관리
                                    </a>
                                    ${user.is_banned ? `
                                        <button
                                            class="contrast outline"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                            onclick="unbanUser(${user.id}, '${user.username}')">
                                            차단 해제
                                        </button>
                                    ` : user.role !== 'super_admin' ? `
                                        <button
                                            class="outline"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                            onclick="showBanModal(${user.id}, '${user.username}')">
                                            차단
                                        </button>
                                    ` : ''}
                                </div>
                                ${user.is_banned ? `
                                    <small style="color: var(--del-color); display: block; margin-top: 0.25rem;">
                                        차단됨: ${user.ban_reason}
                                        ${user.expires_at ? `(만료: ${new Date(user.expires_at).toLocaleDateString('ko-KR')})` : '(영구)'}
                                    </small>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            ${pagination.total_pages > 1 ? `
                <nav aria-label="pagination" style="margin-top: 2rem;">
                    <ul style="display: flex; justify-content: center; list-style: none; padding: 0; gap: 0.5rem;">
                        ${pagination.has_prev ? `
                            <li>
                                <a href="?page=${pagination.current_page - 1}${filters.search ? '&search=' + filters.search : ''}${filters.role ? '&role=' + filters.role : ''}">
                                    이전
                                </a>
                            </li>
                        ` : ''}

                        ${(() => {
                            const startPage = Math.max(1, pagination.current_page - 2);
                            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
                            let pages = '';
                            for (let i = startPage; i <= endPage; i++) {
                                if (i === pagination.current_page) {
                                    pages += '<li><strong>' + i + '</strong></li>';
                                } else {
                                    pages += '<li><a href="?page=' + i + (filters.search ? '&search=' + filters.search : '') + (filters.role ? '&role=' + filters.role : '') + '">' + i + '</a></li>';
                                }
                            }
                            return pages;
                        })()}

                        ${pagination.has_next ? `
                            <li>
                                <a href="?page=${pagination.current_page + 1}${filters.search ? '&search=' + filters.search : ''}${filters.role ? '&role=' + filters.role : ''}">
                                    다음
                                </a>
                            </li>
                        ` : ''}
                    </ul>
                    <p style="text-align: center; color: var(--muted-color); margin-top: 1rem;">
                        전체 ${pagination.total_count}명 중 ${pagination.current_page} / ${pagination.total_pages} 페이지
                    </p>
                </nav>
            ` : ''}
        `}
    </article>

    <div style="margin-top: 2rem;">
        <a href="/admin" role="button" class="secondary">관리자 대시보드로 돌아가기</a>
        <a href="/admin/bans" role="button" class="outline" style="margin-left: 1rem;">차단 목록 보기</a>
    </div>
</div>

<!-- 차단 모달 -->
<dialog id="banModal">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="closeBanModal()"></button>
            <h3>사용자 차단</h3>
        </header>
        <form id="banForm" onsubmit="submitBan(event)">
            <input type="hidden" id="banUserId" name="userId">
            <p>
                <strong id="banUsername"></strong> 사용자를 차단하시겠습니까?
            </p>
            <label for="banReason">
                차단 사유 (필수)
                <textarea
                    id="banReason"
                    name="reason"
                    rows="3"
                    placeholder="차단 사유를 입력하세요"
                    required
                    maxlength="500"></textarea>
            </label>
            <label for="banDuration">
                차단 기간
                <select id="banDuration" name="duration" onchange="toggleCustomDate()">
                    <option value="permanent">영구 차단</option>
                    <option value="1day">1일</option>
                    <option value="7days">7일</option>
                    <option value="30days">30일</option>
                    <option value="90days">90일</option>
                    <option value="custom">사용자 지정</option>
                </select>
            </label>
            <div id="customDateContainer" style="display: none;">
                <label for="customDate">
                    만료일
                    <input
                        type="datetime-local"
                        id="customDate"
                        name="customDate">
                </label>
            </div>
            <footer>
                <button type="button" class="secondary" onclick="closeBanModal()">취소</button>
                <button type="submit">차단</button>
            </footer>
        </form>
    </article>
</dialog>

<script>
    function showBanModal(userId, username) {
        document.getElementById('banUserId').value = userId;
        document.getElementById('banUsername').textContent = username;
        document.getElementById('banReason').value = '';
        document.getElementById('banDuration').value = 'permanent';
        document.getElementById('customDateContainer').style.display = 'none';
        document.getElementById('banModal').showModal();
    }

    function closeBanModal() {
        document.getElementById('banModal').close();
    }

    function toggleCustomDate() {
        const duration = document.getElementById('banDuration').value;
        const container = document.getElementById('customDateContainer');
        container.style.display = duration === 'custom' ? 'block' : 'none';
    }

    async function submitBan(event) {
        event.preventDefault();

        const userId = document.getElementById('banUserId').value;
        const reason = document.getElementById('banReason').value;
        const duration = document.getElementById('banDuration').value;
        const customDate = document.getElementById('customDate').value;

        try {
            const response = await fetch('/admin/users/' + userId + '/ban', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: reason,
                    duration: duration,
                    customDate: customDate
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('사용자가 성공적으로 차단되었습니다.');
                closeBanModal();
                location.reload();
            } else {
                alert('오류: ' + (data.error || '차단 중 오류가 발생했습니다.'));
            }
        } catch (error) {
            console.error('차단 오류:', error);
            alert('차단 중 오류가 발생했습니다.');
        }
    }

    async function unbanUser(userId, username) {
        if (!confirm(username + ' 사용자의 차단을 해제하시겠습니까?')) {
            return;
        }

        try {
            const response = await fetch('/admin/users/' + userId + '/unban', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('사용자 차단이 성공적으로 해제되었습니다.');
                location.reload();
            } else {
                alert('오류: ' + (data.error || '차단 해제 중 오류가 발생했습니다.'));
            }
        } catch (error) {
            console.error('차단 해제 오류:', error);
            alert('차단 해제 중 오류가 발생했습니다.');
        }
    }
</script>
` }) %>
