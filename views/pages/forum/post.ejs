<%- include('../../layouts/main', {
    title: title,
    body: `
        <nav aria-label="breadcrumb">
            <ul>
                <li><a href="/">홈</a></li>
                <li><a href="/forum/subforum/${subforum.id}">${subforum.name}</a></li>
                <li>${post.title}</li>
            </ul>
        </nav>

        <!-- 게시글 내용 -->
        <article class="post-content">
            <header>
                <h1>${post.title}</h1>
                <div class="post-meta">
                    <span class="author">
                        <strong>${post.username}</strong>
                        ${post.role === 'super_admin' ? '<small class="badge admin">관리자</small>' : ''}
                        ${post.role === 'moderator' ? '<small class="badge moderator">모더레이터</small>' : ''}
                    </span>
                    <span class="date">
                        작성: ${new Date(post.created_at).toLocaleString('ko-KR')}
                        ${post.updated_at !== post.created_at ?
                            '<br><small>수정: ' + new Date(post.updated_at).toLocaleString('ko-KR') + '</small>' : ''
                        }
                    </span>
                    <span class="stats">
                        조회 ${post.view_count} · 댓글 ${post.comment_count}
                    </span>
                </div>
            </header>

            <div class="post-body">
                <div class="markdown-content">
                    ${post.content_html || post.content.replace(/\\n/g, '<br>')}
                </div>

                ${post.attachments && post.attachments.length > 0 ? `
                <div class="attachments">
                    <h4>첨부 이미지</h4>
                    <div class="attachment-grid">
                        ${post.attachments.map(attachment => `
                            <div class="attachment-item">
                                <img
                                    src="/forum/subforum/${subforum.id}/attachment/${attachment.id}"
                                    alt="${attachment.original_filename}"
                                    title="${attachment.original_filename}"
                                    loading="lazy"
                                >
                                <div class="attachment-info">
                                    <small>${attachment.original_filename}</small>
                                    <small>${Math.round(attachment.file_size / 1024)}KB</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>

            ${user && user.id === post.user_id ? `
            <footer class="post-actions">
                <a href="/forum/subforum/${subforum.id}/post/${post.id}/edit" role="button" class="outline">수정</a>
                <button type="button" class="outline secondary" onclick="deletePost()">삭제</button>
            </footer>
            ` : ''}
        </article>

        <!-- 댓글 섹션 -->
        <section class="comments-section">
            <header>
                <h2>댓글 (${post.comment_count})</h2>
            </header>

            ${user ? `
            <!-- 댓글 작성 폼 -->
            <form class="comment-form" onsubmit="submitComment(event)">
                <div class="grid">
                    <label for="comment-content">
                        댓글 작성
                        <textarea
                            id="comment-content"
                            name="content"
                            placeholder="댓글을 입력하세요"
                            rows="4"
                            required
                        ></textarea>
                    </label>
                </div>
                <div class="grid">
                    <div></div>
                    <div>
                        <button type="submit" class="contrast">댓글 작성</button>
                    </div>
                </div>
            </form>
            ` : `
            <div class="login-prompt">
                <p><a href="/auth/login">로그인</a>하시면 댓글을 작성할 수 있습니다.</p>
            </div>
            `}

            <!-- 댓글 목록 -->
            <div class="comments-list">
                ${comments.length === 0 ? `
                <div class="no-comments">
                    <p>아직 댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</p>
                </div>
                ` : comments.map(comment => `
                <article class="comment" data-comment-id="${comment.id}">
                    <header class="comment-header">
                        <strong>${comment.username}</strong>
                        ${comment.role === 'super_admin' ? '<small class="badge admin">관리자</small>' : ''}
                        ${comment.role === 'moderator' ? '<small class="badge moderator">모더레이터</small>' : ''}
                        <small class="comment-date">
                            ${new Date(comment.created_at).toLocaleString('ko-KR')}
                            ${comment.updated_at !== comment.created_at ? '(수정됨)' : ''}
                        </small>
                    </header>
                    <div class="comment-body">
                        <p>${comment.content.replace(/\\n/g, '<br>')}</p>
                    </div>
                    ${user && (user.id === comment.user_id || user.role === 'moderator' || user.role === 'super_admin') ? `
                    <footer class="comment-actions">
                        <button type="button" class="outline small" onclick="editComment(${comment.id})">수정</button>
                        <button type="button" class="outline secondary small" onclick="deleteComment(${comment.id})">삭제</button>
                    </footer>
                    ` : ''}
                </article>
                `).join('')}
            </div>
        </section>

        <style>
        .post-content {
            margin-bottom: 2rem;
        }

        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--pico-muted-color);
        }

        .post-meta .author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.admin {
            background-color: var(--pico-primary-background);
            color: var(--pico-primary-inverse);
        }

        .badge.moderator {
            background-color: var(--pico-secondary-background);
            color: var(--pico-secondary-inverse);
        }

        .post-body {
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--pico-muted-border-color);
        }

        .comments-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--pico-muted-border-color);
        }

        .comment-form {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--pico-card-background-color);
            border-radius: 0.5rem;
        }

        .login-prompt {
            text-align: center;
            padding: 2rem;
            background-color: var(--pico-card-background-color);
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }

        .comments-list .comment {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--pico-card-background-color);
            border-radius: 0.5rem;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .comment-date {
            margin-left: auto;
            color: var(--pico-muted-color);
        }

        .comment-body {
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        .comment-actions button.small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .no-comments {
            text-align: center;
            padding: 2rem;
            color: var(--pico-muted-color);
        }

        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content pre {
            background-color: var(--pico-card-background-color);
            padding: 1rem;
            border-radius: 0.25rem;
            overflow-x: auto;
        }

        .markdown-content code {
            background-color: var(--pico-card-background-color);
            padding: 0.125rem 0.25rem;
            border-radius: 0.125rem;
            font-size: 0.875em;
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--pico-primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--pico-muted-color);
        }

        .attachments {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--pico-muted-border-color);
        }

        .attachments h4 {
            margin-bottom: 1rem;
            color: var(--pico-color);
        }

        .attachment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .attachment-item {
            border: 1px solid var(--pico-muted-border-color);
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: var(--pico-card-background-color);
        }

        .attachment-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .attachment-item img:hover {
            transform: scale(1.05);
        }

        .attachment-info {
            padding: 0.5rem;
            text-align: center;
        }

        .attachment-info small {
            display: block;
            color: var(--pico-muted-color);
        }

        @media (max-width: 768px) {
            .post-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .post-actions {
                flex-direction: column;
            }

            .comment-header {
                flex-wrap: wrap;
            }

            .comment-date {
                margin-left: 0;
                width: 100%;
            }
        }
        </style>

        <script>
        async function deletePost() {
            if (!confirm('정말로 이 게시글을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch('/forum/subforum/${subforum.id}/post/${post.id}/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('게시글이 삭제되었습니다.');
                    window.location.href = '/forum/subforum/${subforum.id}';
                } else {
                    alert(result.error || '게시글 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('게시글 삭제 오류:', error);
                alert('게시글 삭제 중 오류가 발생했습니다.');
            }
        }

        async function submitComment(event) {
            event.preventDefault();

            const form = event.target;
            const content = form.content.value.trim();

            if (!content) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/forum/subforum/${subforum.id}/post/${post.id}/comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();

                if (result.success) {
                    alert('댓글이 작성되었습니다.');
                    window.location.reload();
                } else {
                    alert(result.error || '댓글 작성에 실패했습니다.');
                }
            } catch (error) {
                console.error('댓글 작성 오류:', error);
                alert('댓글 작성 중 오류가 발생했습니다.');
            }
        }

        async function editComment(commentId) {
            const commentElement = document.querySelector(\`[data-comment-id="\${commentId}"]\`);
            if (!commentElement) return;

            const contentElement = commentElement.querySelector('.comment-body p');
            const currentContent = contentElement.textContent.replace(/<br>/g, '\\n');

            const newContent = prompt('댓글을 수정하세요:', currentContent);
            if (!newContent || newContent.trim() === '') return;

            try {
                const response = await fetch(\`/forum/subforum/${subforum.id}/comment/\${commentId}\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent.trim() })
                });

                const result = await response.json();

                if (result.success) {
                    alert('댓글이 수정되었습니다.');
                    window.location.reload();
                } else {
                    alert(result.error || '댓글 수정에 실패했습니다.');
                }
            } catch (error) {
                console.error('댓글 수정 오류:', error);
                alert('댓글 수정 중 오류가 발생했습니다.');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('정말로 이 댓글을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(\`/forum/subforum/${subforum.id}/comment/\${commentId}\`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('댓글이 삭제되었습니다.');
                    window.location.reload();
                } else {
                    alert(result.error || '댓글 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('댓글 삭제 오류:', error);
                alert('댓글 삭제 중 오류가 발생했습니다.');
            }
        }
        </script>
    `
}) %>