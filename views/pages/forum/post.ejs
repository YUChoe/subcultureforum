<%- include('../../layouts/main', {
    title: title,
    body: `
        <nav aria-label="breadcrumb">
            <ul>
                <li><a href="/">í™ˆ</a></li>
                <li><a href="/forum/subforum/${subforum.id}">${subforum.name}</a></li>
                <li>${post.title}</li>
            </ul>
        </nav>

        <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        <article class="post-content">
            <header class="post-header">
                <h1 class="post-title">${post.title}</h1>
                <div class="post-meta">
                    <div class="author-info">
                        <div class="author-avatar">
                            ${post.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="author-details">
                            <div class="author-name">
                                ${post.username}
                                ${post.role === 'super_admin' ? '<span class="badge admin">ê´€ë¦¬ì</span>' : ''}
                                ${post.role === 'moderator' ? '<span class="badge moderator">ëª¨ë”ë ˆì´í„°</span>' : ''}
                            </div>
                            <div class="post-date">
                                ì‘ì„±: ${new Date(post.created_at).toLocaleString('ko-KR')}
                                ${post.updated_at !== post.created_at ?
                                    '<br>ìˆ˜ì •: ' + new Date(post.updated_at).toLocaleString('ko-KR') : ''
                                }
                            </div>
                        </div>
                    </div>
                    <div></div>
                    <div class="post-stats">
                        <div>ì¡°íšŒ ${post.view_count}</div>
                        <div>ëŒ“ê¸€ ${post.comment_count}</div>
                    </div>
                </div>
            </header>

            <div class="post-body">
                <div class="markdown-content">
                    ${post.content_html || post.content.replace(/\\n/g, '<br>')}
                </div>

                ${post.attachments && post.attachments.length > 0 ? `
                <div class="attachments">
                    <h4>ì²¨ë¶€ ì´ë¯¸ì§€</h4>
                    <div class="attachment-grid">
                        ${post.attachments.map(attachment => `
                            <div class="attachment-item">
                                <img
                                    src="/forum/subforum/${subforum.id}/attachment/${attachment.id}"
                                    alt="${attachment.original_filename}"
                                    title="${attachment.original_filename}"
                                    loading="lazy"
                                >
                                <div class="attachment-info">
                                    <small>${attachment.original_filename}</small>
                                    <small>${Math.round(attachment.file_size / 1024)}KB</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>

            ${user && user.id === post.user_id ? `
            <footer class="post-actions">
                <a href="/forum/subforum/${subforum.id}/post/${post.id}/edit" role="button" class="outline">ìˆ˜ì •</a>
                <button type="button" class="outline secondary" onclick="deletePost()">ì‚­ì œ</button>
            </footer>
            ` : ''}
        </article>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <section class="comments-section">
            <header class="comments-header">
                <h2>ğŸ’¬ ëŒ“ê¸€ (${post.comment_count})</h2>
            </header>

            ${user ? `
            <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
            <form class="comment-form" onsubmit="submitComment(event)">
                <div class="grid">
                    <label for="comment-content">
                        ëŒ“ê¸€ ì‘ì„±
                        <textarea
                            id="comment-content"
                            name="content"
                            placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                            rows="4"
                            required
                        ></textarea>
                    </label>
                </div>
                <div class="grid">
                    <div></div>
                    <div>
                        <button type="submit" class="contrast">ëŒ“ê¸€ ì‘ì„±</button>
                    </div>
                </div>
            </form>
            ` : `
            <div class="login-prompt">
                <p><a href="/auth/login">ë¡œê·¸ì¸</a>í•˜ì‹œë©´ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            `}

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div class="comments-list">
                ${comments.length === 0 ? `
                <div class="no-comments">
                    <p>ğŸ’­ ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
                ` : comments.map(comment => `
                <article class="comment" data-comment-id="${comment.id}">
                    <header class="comment-header">
                        <div class="comment-author">
                            <div class="comment-avatar">
                                ${comment.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="comment-author-name">
                                    ${comment.username}
                                    ${comment.role === 'super_admin' ? '<span class="badge admin">ê´€ë¦¬ì</span>' : ''}
                                    ${comment.role === 'moderator' ? '<span class="badge moderator">ëª¨ë”ë ˆì´í„°</span>' : ''}
                                </div>
                            </div>
                        </div>
                        <div></div>
                        <div class="comment-date">
                            ${new Date(comment.created_at).toLocaleString('ko-KR')}
                            ${comment.updated_at !== comment.created_at ? ' (ìˆ˜ì •ë¨)' : ''}
                        </div>
                    </header>
                    <div class="comment-body">
                        <p>${comment.content.replace(/\\n/g, '<br>')}</p>
                    </div>
                    ${user && (user.id === comment.user_id || user.role === 'moderator' || user.role === 'super_admin') ? `
                    <footer class="comment-actions">
                        <button type="button" class="outline" onclick="editComment(${comment.id})">ìˆ˜ì •</button>
                        <button type="button" class="outline secondary" onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
                    </footer>
                    ` : ''}
                </article>
                `).join('')}
            </div>
        </section>

        <style>
        /* ê³ ë°€ë„ ì •ë³´ í‘œì‹œë¥¼ ìœ„í•œ ì»´íŒ©íŠ¸ ìŠ¤íƒ€ì¼ */
        .post-content {
            margin-bottom: 1rem;
            background-color: var(--pico-card-background-color);
            border-radius: 0.25rem;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .post-header {
            border-bottom: 1px solid var(--pico-muted-border-color);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        .post-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.2;
            color: var(--pico-color);
        }

        .post-meta {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem;
            align-items: center;
            font-size: 0.85rem;
            color: var(--pico-muted-color);
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .author-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pico-primary), var(--pico-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .author-details {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .author-name {
            font-weight: 600;
            color: var(--pico-color);
            font-size: 0.9rem;
        }

        .post-date {
            font-size: 0.75rem;
            color: var(--pico-muted-color);
        }

        .post-stats {
            text-align: right;
            font-size: 0.8rem;
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.1rem 0.4rem;
            border-radius: 0.75rem;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        .badge.admin {
            background-color: #dc3545;
            color: white;
        }

        .badge.moderator {
            background-color: #28a745;
            color: white;
        }

        .post-body {
            margin: 1rem 0;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .post-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--pico-muted-border-color);
        }

        /* ëŒ“ê¸€ ì„¹ì…˜ - ì»´íŒ©íŠ¸ ìŠ¤íƒ€ì¼ */
        .comments-section {
            margin-top: 1.5rem;
        }

        .comments-header {
            background-color: var(--pico-card-background-color);
            padding: 0.75rem 1rem;
            border-radius: 0.25rem 0.25rem 0 0;
            border-bottom: 2px solid var(--pico-primary);
            font-size: 1rem;
            font-weight: 600;
        }

        .comment-form {
            background-color: var(--pico-card-background-color);
            padding: 1rem;
            border-radius: 0 0 0.25rem 0.25rem;
            margin-bottom: 0.5rem;
        }

        .login-prompt {
            text-align: center;
            padding: 1rem;
            background-color: var(--pico-card-background-color);
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            border: 1px dashed var(--pico-muted-border-color);
        }

        .comments-list {
            background-color: var(--pico-card-background-color);
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .comment {
            border-bottom: 1px solid var(--pico-muted-border-color);
            padding: 0.75rem;
            transition: background-color 0.2s;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment:hover {
            background-color: var(--pico-background-color);
        }

        .comment-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pico-secondary), var(--pico-primary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.7rem;
        }

        .comment-author-name {
            font-weight: 600;
            color: var(--pico-color);
            font-size: 0.85rem;
        }

        .comment-date {
            font-size: 0.75rem;
            color: var(--pico-muted-color);
        }

        .comment-body {
            margin: 0.5rem 0;
            line-height: 1.4;
            font-size: 0.9rem;
            padding-left: 1.75rem;
        }

        .comment-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }

        .comment-actions button {
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.2rem;
        }

        .no-comments {
            text-align: center;
            padding: 1.5rem;
            color: var(--pico-muted-color);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ - ì»´íŒ©íŠ¸ */
        .markdown-content {
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .markdown-content h1 { font-size: 1.4rem; }
        .markdown-content h2 { font-size: 1.2rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content h4 { font-size: 1rem; }

        .markdown-content p {
            margin-bottom: 0.75rem;
        }

        .markdown-content pre {
            background-color: var(--pico-background-color);
            padding: 0.75rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            border: 1px solid var(--pico-muted-border-color);
            font-size: 0.8rem;
        }

        .markdown-content code {
            background-color: var(--pico-background-color);
            padding: 0.1rem 0.3rem;
            border-radius: 0.2rem;
            font-size: 0.85em;
            border: 1px solid var(--pico-muted-border-color);
        }

        .markdown-content blockquote {
            border-left: 3px solid var(--pico-primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--pico-muted-color);
            font-style: italic;
            background-color: var(--pico-background-color);
            padding: 0.75rem 1rem;
            border-radius: 0 0.25rem 0.25rem 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        /* ì²¨ë¶€íŒŒì¼ ìŠ¤íƒ€ì¼ - ì»´íŒ©íŠ¸ */
        .attachments {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: var(--pico-background-color);
            border-radius: 0.25rem;
            border: 1px solid var(--pico-muted-border-color);
        }

        .attachments h4 {
            margin-bottom: 0.75rem;
            color: var(--pico-color);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .attachment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .attachment-item {
            border: 1px solid var(--pico-muted-border-color);
            border-radius: 0.25rem;
            overflow: hidden;
            background-color: var(--pico-card-background-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .attachment-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .attachment-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            cursor: pointer;
        }

        .attachment-info {
            padding: 0.5rem;
            text-align: center;
        }

        .attachment-info small {
            display: block;
            color: var(--pico-muted-color);
            font-size: 0.75rem;
        }

        .attachment-info small:first-child {
            font-weight: 600;
            color: var(--pico-color);
            margin-bottom: 0.1rem;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .post-content {
                padding: 0.75rem;
            }

            .post-title {
                font-size: 1.1rem;
            }

            .post-meta {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .post-stats {
                text-align: left;
            }

            .post-body {
                font-size: 0.9rem;
            }

            .comment-header {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .comment-date {
                text-align: left;
            }

            .comment-body {
                padding-left: 0;
            }

            .attachment-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .post-actions {
                flex-direction: column;
            }
        }

        /* ë‹¤í¬ ëª¨ë“œ ì§€ì› */
        @media (prefers-color-scheme: dark) {
            .post-content {
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }

            .attachment-item:hover {
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            }
        }
        </style>

        <script>
        async function deletePost() {
            if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch('/forum/subforum/${subforum.id}/post/${post.id}/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/forum/subforum/${subforum.id}';
                } else {
                    alert(result.error || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function submitComment(event) {
            event.preventDefault();

            const form = event.target;
            const content = form.content.value.trim();

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/forum/subforum/${subforum.id}/post/${post.id}/comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                } else {
                    alert(result.error || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
                alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function editComment(commentId) {
            const commentElement = document.querySelector(\`[data-comment-id="\${commentId}"]\`);
            if (!commentElement) return;

            const contentElement = commentElement.querySelector('.comment-body p');
            const currentContent = contentElement.textContent.replace(/<br>/g, '\\n');

            const newContent = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:', currentContent);
            if (!newContent || newContent.trim() === '') return;

            try {
                const response = await fetch(\`/forum/subforum/${subforum.id}/comment/\${commentId}\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: newContent.trim() })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                } else {
                    alert(result.error || 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(\`/forum/subforum/${subforum.id}/comment/\${commentId}\`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                } else {
                    alert(result.error || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        </script>
    `
}) %>